<html>
<head>
	<title>Guild Wars 2 Events</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link rel="stylesheet" type="text/css" href="main.css" />
	<script type="text/javascript" src="jquery-2.0.0.min.js"></script>
	<script type="text/javascript" src="main.js"></script>
	<script type="text/javascript">
		// Defaulting to Dzagonur/german
		var params = inherit(Params, {world_id: 2207, lang: "de", type: "chestactive"}).create();
		var initial_params = params;

		$(document).on("click", ".type.action", function(event)
		{
			params.type = $(this).data("type");
			history.replaceState(params, "", make_url(params));
			make_html(params);
		});

		function make_url(params)
		{
			return "events.html?world_id=" + params.world_id + "&lang=" + params.lang + "&type=" + params.type;
		}

		function make_title(params)
		{
			return worlds[params.world_id] + ": Events";
		}

		function make_html(params)
		{
			// Create HTML from the data we have now
			var title = make_title(params);

			window.title = title;
			var html = [];
			html.push("<h1>");
			html.push(title);
			html.push("</h1>");
			html.push("<p class='legend'><span class='Success'>Success</span>\xa0\xa0\xa0<span class='Fail'>Fail</span>\xa0\xa0\xa0<span class='Warmup'>Warmup</span>\xa0\xa0\xa0<span class='Preparation'>Preparation</span>\xa0\xa0\xa0<span class='Active'>Active</span></p>");

			html.push("<p class='actions'>");
			var types = ["all", "active", "chest", "chestactive"];

			var type = params.type || "chestactive";
			for (var i = 0; i < types.length; ++i)
			{
				if (i)
					html.push("\xa0\xa0\xa0")
				html.push("<span class='type " + (type === types[i] ? "noaction" : "action") + " " + types[i] + "' data-type='" + types[i] + "'>" + types[i] + "</span>")
			}
			html.push("</p>");

			var cmp = function(a, b)
			{
				a = events[a];
				b = events[b];
				if (a.map_id > b.map_id)
					return -1;
				else if (a.map_id < b.map_id)
					return 1;
				else if (a.event_id > b.event_id)
					return -1;
				else if (a.event_id < b.event_id)
					return 1;
				else
					return 0;
			};

			var lastmapid = null;
			var type = params.type || "chestactive";

			var sortedeventkeys = [];
			for (var event_id in events)
				sortedeventkeys.push(event_id);
			sortedeventkeys.sort(cmp);

			for (var i = 0; i < sortedeventkeys.length; ++i)
			{
				var event = events[sortedeventkeys[i]];
				if (event.show(type))
				{
					if (event.map_id != lastmapid)
					{
						html.push("<h2>" + maps[event.map_id] + "</h2>");
						lastmapid = event.map_id;
					}
					html.push(event.html(params.lang));
				}
			}
			$("body").html(html.join(""));
			window.setTimeout(function(){display_events(params);}, 10*1000);
		}

		function display_events(params)
		{
			// Fetch information about events
			$.getJSON("https://api.guildwars2.com/v1/events.json", {world_id: params.world_id}, function(data_event_states)
			{
				// We don't have the master data yet => fetch them and create the event objects
				if (!bool(events) || !langs[params.lang])
				{
					$.getJSON("https://api.guildwars2.com/v1/event_names.json", {lang: params.lang}, function(data_events)
					{
						for (var i = 0; i < data_event_states.events.length; ++i)
						{
							var event_data = data_event_states.events[i];
							var event = events[event_data.event_id];
							if (!event)
								event = Event.create(event_data.map_id, event_data.event_id);
							event.setstate(event_data.state);
							events[event.event_id] = event;
						}

						for (var i = 0; i < data_events.length; ++i)
						{
							var event_data = data_events[i];
							if (typeof(events[event_data.id]) !== "undefined") // There might be events that have no state, so we didn't define them
								events[event_data.id].addname(params.lang, event_data.name);
						}

						make_html(params);
					});
				}
				// We already have the names => update state only
				else
				{
					for (var i = 0; i < data_event_states.events.length; ++i)
					{
						var event_data = data_event_state.events[i];
						events[event_data.event_id].setstate(event_data.state);
					}

					make_html(params);
				}
			});
		}
		$(init(params, display_events));
	</script>
</head>
<body>
</body>
</html>
